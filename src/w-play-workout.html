<!--
@license
Copyright (c) 2017 Peter Kaske
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/mixins/gesture-event-listeners.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="w-number-picker.html">
<link rel="import" href="w-slide-up-panel.html">
<link rel="import" href="view-mixin.html">
<link rel="import" href="helpers-mixin.html">
<link rel="import" href="shared-styles.html">

<dom-module id="w-play-workout">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }

      header {
        background: var(--pc-600);
        @apply --layout-horizontal;
        @apply --layout-justified;
        @apply --layout-center;
        background: var(--pc-600);
        padding: 10px;
      }

      header > div:first-child {
        @apply --layout-flex;
      }

      header iron-icon {
        color: var(--gold);
        margin-left: 8px;
      }

      .pr-gold {
        color: var(--gold);
      }

      .content {
        display: grid;
        grid-template-columns: 40px 0.8fr auto;
        padding: 0  0 10px;
        background: var(--pc-800);
      }

      .content > div {
        padding: 10px;
      }

      .content label {
        color: var(--pc-300);
        border-bottom: none;
        padding: 5px 10px;
        background: transparent;
      }

      .content .column-header {
        padding: 15px 10px 10px;
      }

      .set-number {
        color: var(--pc-600);
        background: var(--pc-300);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        line-height: 30px;
        text-align: center;
      }

      .weight-picker {
        margin-right: 5px;
        --w-number-picker-nob: {
          width: auto;
        };
        --w-number-picker-nob-bubble: {
          border-radius: 5px;
        };
      }

      .reps-picker {
        margin-right: 10px;
      }

      .weight-picker {
        margin-left: 10px;
      }

      .content .darker {
        background: var(--pc-850);
      }

      .content .current-record {
        @apply --layout-horizontal;
        @apply --layout-center-center;
      }

      .content .check-set {
        padding: 7px 0;
        align-self: center;
      }
    </style>

    <w-slide-up-panel full id="panel">
      <paper-icon-button icon="wi:arrow-back" slot="header-left" dismiss-panel></paper-icon-button>
      <h1 slot="header">[[_session.name]]</h1>

      <template is="dom-repeat" items="[[_exercises]]" as="ex">
        <iron-form>
          <form>
            <section class="margin-top-25">
              <header>
                <div>[[ex.name]]</div>
                <template is="dom-if" if="[[_has('allTimePr', ex)]]">
                  <div>
                    <span class="pr-gold">[[_weight(ex.allTimePr, settings.weightUnit)]] [[settings.weightUnit]]</span>
                    <iron-icon icon="wi:trophy"></iron-icon>
                  </div>
                </template>
              </header>
              <div class="content">
                <label class="darker column-header"></label>
                <label class="darker column-header prev-record"><span>[[localize('last-time')]]</span></label>
                <label class="column-header">[[localize('this-time')]]</label>

                <template is="dom-repeat" items="[[_getSets(ex)]]" as="set">
                  <div class="darker">
                    <div class="set-number">[[set.number]]</div>
                  </div>
                  
                  <div class="darker prev-record horizontal center">
                    <label class="text-center flex" hidden$="[[_hasRecords(ex)]]">[[localize('no-records-for-exercise')]]</label>
                  </div>

                  <div class="current-record">
                    <w-number-picker
                      class="reps-picker"
                      min="1"
                      max="100"
                      name="reps"></w-number-picker>
                    <span>x</span>
                    <w-number-picker
                      class="weight-picker"
                      min="0"
                      max="9999"
                      step="1.25"
                      sensitivity="80"
                      name="weight"></w-number-picker>
                    <span>[[settings.weightUnit]]</span>
                  </div>
                </template>

              </div>
            </section>
          </form>
        </iron-form>
      </template>
    </w-slide-up-panel>
  </template>

  <script>
    class WPlayWorkout extends Polymer.GestureEventListeners(HelpersMixin(ViewMixin(Polymer.mixinBehaviors([ Polymer.AppLocalizeBehavior ], Polymer.Element)))) {
      static get is() { return 'w-play-workout'; }

      static get properties() {
        return {
          exercisesMap: {
            type: Map
          },

          resources: {
            type: Object
          },

          _session: {
            type: Object
          },

          _currentSet: {
            type: String
          }
        };
      }

      start(session) {
        this._session = session;
        this.$.panel.show();
        this._getExercises();
      }

      async _getExercises() {
        const result = await window.App.Exercises.findWithRecords(this._session.exercises.map(ex => ex.id));
        const exWithRecords = result.docs;
        const populatedList = [];
        this._session.exercises.forEach(ex => {
          const srcEx = exWithRecords.find(exWR => ex.id === exWR._id);
          if (srcEx) {
            srcEx.allTimePr = 20;
            populatedList.push(Object.assign(ex, srcEx));
          }
        });

        this._exercises = populatedList;
      }

      _getSets(ex) {
        const record = this._getLatestRecord(ex);
        const recordedSets = record.sets || [];

        // We show as many sets as were recorded the last time
        // or at lease as many as were defined in the workout plan.
        const setsToShow = Math.max(recordedSets.length, ex.sets);
        const data = [];
        for (var i = 0; i < setsToShow; i++) {
          data.push({
            number: i + 1,
            previous: recordedSets[i]
          });
        }

        return data;
      }
    }

    window.customElements.define(WPlayWorkout.is, WPlayWorkout);
  </script>
</dom-module>
